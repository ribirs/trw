<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>공 게임</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #f0f0f0;
      font-family: sans-serif;
      touch-action: none; /* 드래그 확대 방지 */
    }

    #ball {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: crimson;
      border-radius: 50%;
      z-index: 2;
    }

    .flame {
      position: absolute;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, orange, red, transparent);
      border-radius: 50%;
      opacity: 0.8;
      pointer-events: none;
      z-index: 1;
      animation: flicker 0.4s ease-out forwards;
    }

    .green-ball {
      position: absolute;
      background-color: green;
      border-radius: 50%;
      z-index: 1;
      animation: pulse 2s infinite ease-in-out;
    }
    .orange-ball {
      position: absolute;
      background-color: orange;
      border-radius: 50%;
      z-index: 1;
      animation: spin 3s linear infinite;
    }
    /* 필요 시 파티클 원에 부드러운 그림자 추가 */
    .particle {
      box-shadow: 0 0 8px 2px rgba(0, 255, 0, 0.7);
    }


    @keyframes flicker {
      0% { transform: scale(1) translateY(0); opacity: 1; }
      100% { transform: scale(2) translateY(20px); opacity: 0; }
    }

    @keyframes levelUpFlash {
      0%   { transform: scale(1); background-color: rgba(100,100,100,0.3); }
      50%  { transform: scale(1.1); background-color: rgba(255,255,255,0.6); }
      100% { transform: scale(1); background-color: rgba(100,100,100,0.3); }
    }
    #hud {
      position: fixed;
      top: 10px;
      left: 0;
      width: 100vw;  /* 화면 가로 전체 */
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.5);
      box-sizing: border-box;
      border-radius: 0 0 15px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: white;
      z-index: 1000;
      user-select: none;
    }

    #level {
      display: flex;
      align-items: center;
      font-size: 18px;
      font-weight: 600;
    }
    #exp-container {
      width: 90%;
      margin: 10px auto;
      position: relative;
    }
    #exp-bar-full {
      position: relative;
      width: 100%;
      height: 20px;
      background-color: #333;
      border-radius: 10px;
      overflow: hidden;
    }

    .icon {
      margin-right: 8px;
      font-size: 22px;  /* 아이콘 크기 */
      user-select: none;
    }

    /* 경험치 바 컨테이너 (길게 누르는 경험치 숫자 포함) */
    #exp-container {
      flex-grow: 1;
      margin-left: 20px;
      gap: 10px;
    }

    /* 경험치바 디자인 */
    #exp-bar {
      height: 100%;
      background: linear-gradient(90deg, #00ff00, #00aaff);
      transition: width 0.3s ease;
    }
    #exp-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: bold;
      color: red;
      font-size: 14px;
      text-shadow: 
        -1px -1px 0 yellow,  
        1px -1px 0 yellow,  
        -1px  1px 0 yellow,  
        1px  1px 0 yellow;
      pointer-events: none;
      z-index: 2;
    }


    /* 실제 경험치 진행 바 (별도 요소로 만들면 좋음) */
    #exp-bar::after {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 0%;  /* JS에서 %에 따라 조절 */
      background: linear-gradient(90deg, #00ff00, #0000ff);
      border-radius: 9px;
      transition: width 0.3s ease;
      box-shadow: 0 0 8px #00ffcc;
    }

    /* 경험치 숫자 */
    #exp-percent {
      min-width: 80px;
      color: white; /* 짙은 회색 */
      font-weight: 500;
      margin-left: 10px;
      user-select: none;
    }


    #buttons {
      margin-top: 8px;
    }

    button {
      font-size: 12px;
      margin-right: 5px;
      padding: 2px 6px;
      cursor: pointer;
    }

    input[type="file"] {
      display: none;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(2); }
    }

    @keyframes spin {
      0%, 100% { transform: scale(0.8); }
      50% { transform: scale(0.1); }
    }

    .collision-effect {
      position: absolute;
      border-radius: 50%;
      border: 1px solid green;
      opacity: 0.8;
      pointer-events: none;
      animation: collisionFade 1s forwards;
      z-index: 3;
      width: 30px;
      height: 30px;
    }

    @keyframes collisionFade {
      0% { opacity: 0.8; transform: scale(1);}
      100% { opacity: 0; transform: scale(2);}
    }
    #touch-controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      text-align: center;
      user-select: none;
      display:none;
    }

    .dir-btn {
      width: 60px;
      height: 60px;
      margin: 5px;
      font-size: 24px;
      border-radius: 10px;
      border: none;
      background-color: #ccc;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }
    .dir-btn:active {
      background-color: #999;
    }
    button {
      padding: 8px 20px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      background: linear-gradient(to bottom, #4a90e2, #357ab7);
      color: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
      margin: 4px;
    }
    button:hover {
      background: linear-gradient(to bottom, #5aa6f2, #3e8ad2);
      transform: translateY(-1px);
    }
    button:active {
      transform: translateY(0);
    }

    @media screen and (max-width: 768px) {
      .joystick-container {
        position: fixed;
        bottom: 10px;
        left: 10px;
        z-index: 1000;
      }
    }
    #balleat {
      font-weight: bold;
      font-size: 18px;
      user-select: none;
    }

    .balleat-icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }

    .green-icon {
      background-color: #28a745; /* 초록색 */
    }

    .orange-icon {
      background-color: #ff7f00; /* 주황색 */
    }

    .balleat-item {
      margin-right: 15px;
    }

  </style>
</head>
<body>
  <p id="balleat"></p>
  <div id="ball"></div>
  <div id="hud">
    <div id="level">1<span class="icon">⭐</span></div>
    <div id="exp-container" style="flex-grow: 1; margin-left: 20px;">
      <div id="exp-bar-full"> <!-- 고정 100% 너비 배경 -->
        <span id="exp-text">0% (0/10)</span> <!-- 항상 가운데 정렬 -->
        <div id="exp-bar"></div> <!-- 실제 경험치 진행 바 -->
      </div>
    </div>
    
    <div id="buttons">
      <button onclick="saveData()">Save</button>
      <button onclick="document.getElementById('fileInput').click()">Load</button>
      <input type="file" id="fileInput" accept=".json" />
    </div>
  </div>

  <div id="touch-controls">
    <button class="dir-btn" data-dir="up">▲</button><br>
    <button class="dir-btn" data-dir="left">◀</button>
    <button class="dir-btn" data-dir="down">▼</button>
    <button class="dir-btn" data-dir="right">▶</button>
  </div>
  <div id="joystick-container" style="position: fixed; bottom: 100px; left: 100px; width: 150px; height: 150px; background: rgba(0,0,0,0.3); border-radius: 50%; touch-action: none; z-index: 1000;">
    <div id="joystick-thumb" style="width: 60px; height: 60px; background: rgba(255,255,255,0.7); border-radius: 50%; position: absolute; top: 45px; left: 45px;"></div>
  </div>
  

  <script>
    const ball = document.getElementById("ball");
    const levelEl = document.getElementById("level");
    const expBar = document.getElementById("exp-bar");
    const expPercentEl = document.getElementById("exp-text");
    const hud = document.getElementById("hud");
    const fileInput = document.getElementById("fileInput");

    const greenBalls = [];
    const greenBallCount = 10;

    const orangeBalls = [];
    const orangeBallCount = 5;

    const isMobile = window.innerWidth <= 368;
    const ballSize = isMobile ? 100 : 50;
    const greenSize = ballSize / 2;
    const orangeSize = greenSize / 2;
    

    let x = 100, y = 100;
    let vx = 0, vy = 0;
    const baseAcceleration = 0.5;
    const baseMaxSpeed = 10;
    let acceleration = baseAcceleration;
    let maxSpeed = baseMaxSpeed;
    const friction = 0.95;
    let boostMode = false;
    let lastFlameTime = 0;
    const flameInterval = 50;

    let greenEatCount = 0;
    let orangeEatCount = 0;


    const keys = {
      ArrowUp: false, ArrowDown: false,
      ArrowLeft: false, ArrowRight: false
    };
    const joystickContainer = document.getElementById("joystick-container");
    const joystickThumb = document.getElementById("joystick-thumb");

    let joystickActive = false;
    let joystickStartX = 0;
    let joystickStartY = 0;
    let joystickX = 0;
    let joystickY = 0;

    let slowedMode = false; // 클릭으로 느려진 상태

    // Lv/경험치 상태
    let level = 1;
    let exp = 0;

    // 키 입력 처리
    document.addEventListener("keydown", (e) => {
      if (e.key in keys) keys[e.key] = true;

      if (e.code === "Space" && !e.repeat) {
        boostMode = !boostMode;
        acceleration = boostMode ? baseAcceleration * 2 : baseAcceleration;
        maxSpeed = boostMode ? baseMaxSpeed * 2 : baseMaxSpeed;
        ball.style.backgroundColor = boostMode ? "orange" : "crimson";
      }
    });

    document.addEventListener("keyup", (e) => {
      if (e.key in keys) keys[e.key] = false;
    });
    // ↙ 여기 추가! ↙
    document.querySelectorAll(".dir-btn").forEach(btn => {
      const dir = btn.dataset.dir;
      const key = "Arrow" + dir.charAt(0).toUpperCase() + dir.slice(1);

      btn.addEventListener("touchstart", e => {
        e.preventDefault();
        keys[key] = true;
      });
      btn.addEventListener("touchend", e => {
        e.preventDefault();
        keys[key] = false;
      });

      btn.addEventListener("mousedown", e => {
        keys[key] = true;
      });
      btn.addEventListener("mouseup", e => {
        keys[key] = false;
      });
      btn.addEventListener("mouseleave", e => {
        keys[key] = false;
      });
    });

    // 조이스틱 터치 시작
    joystickContainer.addEventListener("touchstart", e => {
      e.preventDefault();
      joystickActive = true;
      const touch = e.touches[0];
      joystickStartX = touch.clientX;
      joystickStartY = touch.clientY;
      joystickX = 0;
      joystickY = 0;
      joystickThumb.style.transition = "none";
      joystickThumb.style.left = "45px";
      joystickThumb.style.top = "45px";
    });

    // 조이스틱 터치 이동
    joystickContainer.addEventListener("touchmove", e => {
      if (!joystickActive) return;
      e.preventDefault();
      const touch = e.touches[0];
      joystickX = touch.clientX - joystickStartX;
      joystickY = touch.clientY - joystickStartY;

      // 최대 반경 제한 (예: 50px)
      const maxRadius = 50;
      const dist = Math.hypot(joystickX, joystickY);
      if (dist > maxRadius) {
        joystickX = (joystickX / dist) * maxRadius;
        joystickY = (joystickY / dist) * maxRadius;
      }

      joystickThumb.style.left = (45 + joystickX) + "px";
      joystickThumb.style.top = (45 + joystickY) + "px";
    });

    // 조이스틱 터치 끝
    joystickContainer.addEventListener("touchend", e => {
      joystickActive = false;
      joystickX = 0;
      joystickY = 0;
      joystickThumb.style.transition = "all 0.3s ease";
      joystickThumb.style.left = "45px";
      joystickThumb.style.top = "45px";
    });

    

    function createFireworks() {
      // 배경 검게 만들기
      const overlay = document.createElement("div");
        overlay.style.position = "fixed";
        overlay.style.top = 0;
        overlay.style.left = 0;
        overlay.style.width = "100%";
        overlay.style.height = "100%";
        overlay.style.backgroundColor = "rgba(0, 0, 0, 0.8)";
        overlay.style.zIndex = 999;
        overlay.style.pointerEvents = "none";
        overlay.style.opacity = "0";
        overlay.style.transition = "opacity 0.3s ease";

        document.body.appendChild(overlay);

        // 깜빡임 애니메이션
        requestAnimationFrame(() => {
          overlay.style.opacity = "0.9";
          setTimeout(() => {
            overlay.style.opacity = "0";
            setTimeout(() => {
              overlay.remove();
            }, 600);
          }, 600);
        });

      const colors = ["#ff3f3f", "#ffaf3f", "#fff33f", "#3fff3f", "#3fafff", "#af3fff"];
      const numParticles = 30;

      for (let i = 0; i < numParticles; i++) {
        const particle = document.createElement("div");
        particle.style.position = "absolute";
        particle.style.borderRadius = "50%";
        particle.style.width = "6px";
        particle.style.height = "6px";
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        const startX = Math.random() * window.innerWidth;
        const startY = Math.random() * window.innerHeight;
        particle.style.left = startX + "px";
        particle.style.top = startY + "px";
        particle.style.zIndex = 1000;
        particle.style.pointerEvents = "none";
        document.body.appendChild(particle);

        const angle = (Math.PI * 2 / numParticles) * i;
        const speed = 5 + Math.random() * 20;
        let x = window.innerWidth / 2;
        let y = window.innerHeight / 2;
        let life = 60;

        function animate() {
          x += Math.cos(angle) * speed;
          y += Math.sin(angle) * speed;
          particle.style.left = x + "px";
          particle.style.top = y + "px";
          life--;
          particle.style.opacity = life / 30;
          if (life > 0) {
            requestAnimationFrame(animate);
          } else {
            particle.remove();
          }
        }
        animate();
      }
    }
    //빨간공 클릭
    ball.addEventListener("click", () => {
      slowedMode = !slowedMode;

      if (slowedMode) {
        acceleration = baseAcceleration * 0.25;
        maxSpeed = baseMaxSpeed * 0.25;
        ball.style.backgroundColor = "blue"; // 파란색으로
      } else {
        // boostMode 여부에 따라 원래대로
        acceleration = boostMode ? baseAcceleration * 2 : baseAcceleration;
        maxSpeed = boostMode ? baseMaxSpeed * 2 : baseMaxSpeed;
        ball.style.backgroundColor = boostMode ? "orange" : "crimson";
      }
    });

    // 초록공 클릭 애니메이션
    function createClickExplosion(cx, cy) {
      const colors = ["#00ff00", "#a0ffa0", "#00cc00", "#55ff55", "#88ff88"];
      const numParticles = 20;

      for (let i = 0; i < numParticles; i++) {
        const particle = document.createElement("div");
        particle.style.position = "absolute";
        particle.style.borderRadius = "50%";
        particle.style.width = "8px";
        particle.style.height = "8px";
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        particle.style.left = cx + "px";
        particle.style.top = cy + "px";
        particle.style.pointerEvents = "none";
        particle.style.zIndex = 1000;
        document.body.appendChild(particle);

        const angle = (Math.PI * 2 / numParticles) * i;
        const speed = 2 + Math.random() * 4;
        let x = cx;
        let y = cy;
        let life = 40;

        function animate() {
          x += Math.cos(angle) * speed;
          y += Math.sin(angle) * speed;
          particle.style.left = x + "px";
          particle.style.top = y + "px";
          life--;
          particle.style.opacity = life / 40;
          particle.style.transform = `scale(${life / 40})`;
          if (life > 0) {
            requestAnimationFrame(animate);
          } else {
            particle.remove();
          }
        }
        animate();
      }
    }
    // 주황공 클릭 애니메이션
    function createOrangeClickExplosion(cx, cy) {
      const colors = ["#ff8c00", "#ffaa33", "#ffbb55", "#ffcc77", "#ffdd99"];
      const numParticles = 30;

      for (let i = 0; i < numParticles; i++) {
        const particle = document.createElement("div");
        particle.style.position = "absolute";
        particle.style.borderRadius = "50%";
        particle.style.width = "12px";  // 더 크게
        particle.style.height = "12px";
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        particle.style.left = cx + "px";
        particle.style.top = cy + "px";
        particle.style.pointerEvents = "none";
        particle.style.zIndex = 1000;
        document.body.appendChild(particle);

        const angle = (Math.PI * 2 / numParticles) * i;
        const speed = 3 + Math.random() * 6;  // 더 빠르게
        let x = cx;
        let y = cy;
        let life = 50;

        function animate() {
          x += Math.cos(angle) * speed;
          y += Math.sin(angle) * speed;
          particle.style.left = x + "px";
          particle.style.top = y + "px";
          life--;
          particle.style.opacity = life / 50;
          particle.style.transform = `scale(${life / 50})`;
          if (life > 0) {
            requestAnimationFrame(animate);
          } else {
            particle.remove();
          }
        }
        animate();
      }
    }




    function createFlame(x, y) {
      const flame = document.createElement("div");
      flame.className = "flame";
      flame.style.left = x + "px";
      flame.style.top = y + "px";
      document.body.appendChild(flame);
      setTimeout(() => flame.remove(), 400);
    }

    function spawnGreenBall() {
      const div = document.createElement("div");
      div.className = "green-ball";
      div.style.width = greenSize + "px";
      div.style.height = greenSize + "px";
      div.style.position = "absolute";  // 혹시 없으면 추가
      document.body.appendChild(div);

      // 클릭 이벤트 추가
      div.addEventListener("click", () => {
        // 클릭 위치 중앙 좌표 계산
        const cx = parseFloat(div.style.left) + greenSize / 2;
        const cy = parseFloat(div.style.top) + greenSize / 2;

        // 충돌 이펙트 애니메이션 실행2
        createClickExplosion(cx, cy);
        // createCollisionEffect(cx, cy);

        // 경험치 획득
        exp += 1;
        if (exp >= level * 10) {
          level += 1;
          exp = 0;
          animateLevelUp();
        }
        updateHUD();

        // 초록공 재생성
        respawnGreenBall(greenBallObj);
      });

      // 객체 반환 (이벤트에서 참조할 수 있도록 변수 필요)
      const greenBallObj = {
        el: div,
        x: Math.random() * (window.innerWidth - greenSize),
        y: Math.random() * (window.innerHeight - greenSize),
        vx: (Math.random() - 0.5) * 4,
        vy: (Math.random() - 0.5) * 4
      };

      // 초록공 위치 초기화
      div.style.left = greenBallObj.x + "px";
      div.style.top = greenBallObj.y + "px";

      return greenBallObj;
    }


    function spawnOrangeBall() {
      const div = document.createElement("div");
      div.className = "orange-ball";
      div.style.width = orangeSize + "px";
      div.style.height = orangeSize + "px";
      div.style.position = "absolute";
      div.style.borderRadius = "50%";
      div.style.zIndex = "1";
      document.body.appendChild(div);

      // 클릭이벤트
      div.addEventListener("click", () => {
        const cx = parseFloat(div.style.left) + orangeSize / 2;
        const cy = parseFloat(div.style.top) + orangeSize / 2;

        createOrangeClickExplosion(cx, cy);

        exp += 5;
        if (exp >= level * 10) {
          level += 1;
          exp = 0;
          animateLevelUp();
        }
        updateHUD();

        respawnOrangeBall(orangeBallObj);
      });

      const interval = 3000 + Math.random() * 4000;

      return {
        el: div,
        x: Math.random() * (window.innerWidth - orangeSize),
        y: Math.random() * (window.innerHeight - orangeSize),
        vx: (Math.random() - 0.5) * 4,
        vy: (Math.random() - 0.5) * 4,
        changeInterval: interval,
        changeDirectionTimer: Math.random() * interval  // 여기 랜덤 초기값으로 변경
      };
      

    }


    function respawnGreenBall(gb) {
      gb.x = Math.random() * (window.innerWidth - greenSize);
      gb.y = Math.random() * (window.innerHeight - greenSize);
      gb.vx = (Math.random() - 0.5) * 4;
      gb.vy = (Math.random() - 0.5) * 4;
      // 초록공 먹을 때
      greenEatCount++;
      updateBallEatUI();
    }
    function respawnOrangeBall(ob) {
      ob.x = Math.random() * (window.innerWidth - orangeSize);
      ob.y = Math.random() * (window.innerHeight - orangeSize);
      ob.vx = (Math.random() - 0.5) * 4;
      ob.vy = (Math.random() - 0.5) * 4;
      // 주황공 먹을 때
      orangeEatCount++;
      updateBallEatUI();
    }
    function updateBallEatUI() {
      const p = document.getElementById("balleat");
      p.innerHTML = `
        <span class="balleat-item">
          <span class="balleat-icon green-icon"></span> ${greenEatCount}
        </span>
        /
        <span class="balleat-item">
          <span class="balleat-icon orange-icon"></span> ${orangeEatCount}
        </span>
      `;
    }

    function checkCollision(ax, ay, asize, bx, by, bsize) {
      const dx = ax + asize / 2 - (bx + bsize / 2);
      const dy = ay + asize / 2 - (by + bsize / 2);
      return Math.hypot(dx, dy) < (asize + bsize) / 2;
    }

    function updateHUD() {
      levelEl.innerHTML = `${level}<span class="icon">⭐</span>`;
      
      const required = level * 10;
      const percent = Math.floor((exp / required) * 100);

      // 경험치바 너비를 직접 조절 (expBar 자체의 너비는 100%로 고정)
      expBar.style.width = percent + "%";

      expPercentEl.textContent = `${percent}% (${exp}/${required})`;
    }



    function animateLevelUp() {
      hud.style.animation = "levelUpFlash 0.6s ease";
      setTimeout(() => {
        hud.style.animation = "";
      }, 600);
      createFireworks(); // 폭죽 이펙트 호출
    }

    function createCollisionEffect(cx, cy) {
      const effect = document.createElement("div");
      effect.className = "collision-effect";
      effect.style.left = (cx - 15) + "px";
      effect.style.top = (cy - 15) + "px";
      document.body.appendChild(effect);
      setTimeout(() => effect.remove(), 500);
    }

    for (let i = 0; i < greenBallCount; i++) {
      greenBalls.push(spawnGreenBall());
    }
    for (let i = 0; i < orangeBallCount; i++) {
      orangeBalls.push(spawnOrangeBall());
    }

    let lastTimestamp = 0;

    function update(timestamp) {
      if (!lastTimestamp) lastTimestamp = timestamp;
      const deltaTime = timestamp - lastTimestamp;
      lastTimestamp = timestamp;

      const screenWidth = window.innerWidth;
      const screenHeight = window.innerHeight;

      if (keys.ArrowUp) vy -= acceleration;
      if (keys.ArrowDown) vy += acceleration;
      if (keys.ArrowLeft) vx -= acceleration;
      if (keys.ArrowRight) vx += acceleration;
      // ↓ 아래 코드를 대체하거나 추가해서 조이스틱 입력도 반영
      // joystickX, joystickY 값 범위가 -50 ~ 50 이므로 50으로 나누어 -1 ~ 1 범위로 변환
      if (joystickActive) {
        vx += (joystickX / 50) * acceleration;
        vy += (joystickY / 50) * acceleration;
      }

      vx = Math.max(-maxSpeed, Math.min(maxSpeed, vx));
      vy = Math.max(-maxSpeed, Math.min(maxSpeed, vy));

      x += vx;
      y += vy;

      if (x + ballSize < 0) x = screenWidth;
      else if (x > screenWidth) x = -ballSize;
      if (y + ballSize < 0) y = screenHeight;
      else if (y > screenHeight) y = -ballSize;

      vx *= friction;
      vy *= friction;

      ball.style.left = x + "px";
      ball.style.top = y + "px";

      if (boostMode && timestamp - lastFlameTime > flameInterval) {
        lastFlameTime = timestamp;
        createFlame(x + ballSize / 2 - 10, y + ballSize / 2);
      }

      for (const gb of greenBalls) {
        gb.x += gb.vx * 0.4;
        gb.y += gb.vy * 0.4;

        if (gb.x + greenSize < 0) gb.x = screenWidth;
        else if (gb.x > screenWidth) gb.x = -greenSize;
        if (gb.y + greenSize < 0) gb.y = screenHeight;
        else if (gb.y > screenHeight) gb.y = -greenSize;

        gb.el.style.left = gb.x + "px";
        gb.el.style.top = gb.y + "px";

        // 초록공 충돌 감지 후
        if (checkCollision(x, y, ballSize, gb.x, gb.y, greenSize)) {
          createCollisionEffect(gb.x + greenSize / 2, gb.y + greenSize / 2);
          respawnGreenBall(gb);
          exp += 1;
          if (exp >= level * 10) {
            level += 1;
            exp = 0;
            animateLevelUp();
          }
          updateHUD();
        }
      }

      for (const ob of orangeBalls) {
        // 방향 변경 타이머 증가
        ob.changeDirectionTimer += deltaTime;

        if (ob.changeDirectionTimer > ob.changeInterval) {
          ob.vx = (Math.random() - 0.5) * 4;
          ob.vy = (Math.random() - 0.5) * 4;
          ob.changeDirectionTimer = 0;
          ob.changeInterval = 3000 + Math.random() * 4000;
        }

        ob.x += ob.vx * 1.6;  // 주황공 속도
        ob.y += ob.vy * 1.6;

        // 화면 밖 순환 처리
        if (ob.x + orangeSize < 0) ob.x = screenWidth;
        else if (ob.x > screenWidth) ob.x = -orangeSize;
        if (ob.y + orangeSize < 0) ob.y = screenHeight;
        else if (ob.y > screenHeight) ob.y = -orangeSize;

        ob.el.style.left = ob.x + "px";
        ob.el.style.top = ob.y + "px";

        if (checkCollision(x, y, ballSize, ob.x, ob.y, orangeSize)) {
          createCollisionEffect(ob.x + orangeSize / 2, ob.y + orangeSize / 2);
          respawnOrangeBall(ob);
          exp += 5;
          if (exp >= level * 10) {
            level += 1;
            exp = 0;
            animateLevelUp();
          }
          updateHUD();
        }
      }


      

      requestAnimationFrame(update);
    }

    updateHUD();
    requestAnimationFrame(update);

    // ✅ 저장
    function saveData() {
      const data = {
        level,
        exp
      };
      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const filename = `ball_save_${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}.json`;
      const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    // ✅ 불러오기
    fileInput.addEventListener("change", function () {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.level && typeof data.exp === "number") {
            level = data.level;
            exp = data.exp;
            updateHUD();
          } else {
            alert("잘못된 세이브 파일입니다.");
          }
        } catch {
          alert("파일을 읽을 수 없습니다.");
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
